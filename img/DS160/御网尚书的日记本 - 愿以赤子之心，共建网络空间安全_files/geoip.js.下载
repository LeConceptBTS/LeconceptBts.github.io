// 立即执行函数，创建一个闭包并返回一个函数
var foreignTips = (function () {
  var onSuccess = function (geoipResponse) {
    if (!geoipResponse.country.iso_code) {
      return;
    }
    var code = geoipResponse.country.iso_code.toLowerCase();
    if (code != 'cn') {
      anzhiyu.snackbarShow('已检测到您使用国外网络访问本站。We have detected that you are using a foreign network to access this website');
      // 显示 5 秒钟后隐藏
      setTimeout(function () {
        // 清除页面全部 div
        $('div').remove();
        setTimeout(function() {
          alert('当您使用国外网络（翻墙）访问本站时，本站将不再显示页面内容，请您遵守中国法律法规。');
        }, 1000); // 2秒后弹出提示框
      }, 5000);
    }
  };
  var onError = function (error) {};
  return function () {
    geoip2.country(onSuccess, onError);
  };
})();

$(document).ready(function() {
  // 在页面初次加载时调用自执行函数
  foreignTips();

  // 启用 Pjax
  $('body').pjax('a', '#pjax-container');

  // 在每次页面切换时暂停定时任务、取消已经排队但还未执行的代码、解绑事件处理函数等操作
  $(document).on('pjax:beforeSend', function() {
    clearTimeout(foreignTips.timer);
    $(document).off('click', '#cancel');
  });
  $(document).on('pjax:end', function() {
    foreignTips.timer = setTimeout(foreignTips, 5000);
    $(document).on('click', '#cancel', function(e) {
      e.stopPropagation();
      e.preventDefault();
      clearTimeout(foreignTips.timer);
      $(document).off('click', '#cancel');
    });
  });
});
